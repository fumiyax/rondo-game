<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é³¥ã‹ã”ãƒã‚¹ã‚¿ãƒ¼ âš½</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
:root{--neon:#b8ff4e;--red:#ff3b3b;--blue:#3baaff;--white:#f5fff0;--dark:#0a1a0f;--orange:#ff9500;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);font-family:'Noto Sans JP',sans-serif;color:var(--white);min-height:100vh;}
header{text-align:center;padding:10px 10px 3px;}
header h1{font-family:'Orbitron',sans-serif;font-size:clamp(15px,4vw,24px);color:var(--neon);letter-spacing:3px;text-shadow:0 0 18px rgba(184,255,78,0.5);}
header p{font-size:10px;color:rgba(255,255,255,0.4);margin-top:2px;}

/* â”€â”€ TABS â”€â”€ */
.main-tabs{display:flex;justify-content:center;background:rgba(0,0,0,0.5);border-bottom:1px solid rgba(255,255,255,0.08);}
.main-tab{flex:1;max-width:150px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:13px;padding:10px 0;border:none;background:transparent;color:rgba(255,255,255,0.35);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
.main-tab.active{color:var(--neon);border-bottom-color:var(--neon);}

/* â”€â”€ SECTION VISIBILITY â”€â”€ */
.section{display:none;}
.section.visible{display:block;}

/* â”€â”€ PLAY SECTION â”€â”€ */
.mode-bar{display:flex;justify-content:center;gap:7px;padding:6px 10px;background:rgba(0,0,0,0.35);}
.mode-btn{font-family:'Orbitron',sans-serif;font-size:10px;padding:5px 12px;border:2px solid rgba(184,255,78,0.3);border-radius:14px;background:transparent;color:rgba(255,255,255,0.4);cursor:pointer;transition:all 0.2s;}
.mode-btn.active{border-color:var(--neon);color:var(--neon);background:rgba(184,255,78,0.09);}
.stats-bar{display:flex;justify-content:center;gap:12px;padding:5px 14px;background:rgba(0,0,0,0.4);border-bottom:1px solid rgba(184,255,78,0.1);}
.stat{text-align:center;}
.stat .lbl{font-size:8px;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:1px;}
.stat .val{font-family:'Orbitron',sans-serif;font-size:16px;color:var(--neon);line-height:1.1;}
.val.red{color:var(--red);}.val.blue{color:var(--blue);}
.timer-wrap{display:flex;align-items:center;gap:5px;}
#timer-bar{width:70px;height:5px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;}
#timer-fill{height:100%;background:var(--neon);border-radius:3px;transition:width 0.1s,background 0.3s;width:100%;}
.game-wrapper{display:flex;flex-direction:column;align-items:center;padding:7px;gap:7px;}
#field-container{position:relative;width:100%;max-width:600px;}
#field{width:100%;border-radius:10px;border:2px solid rgba(184,255,78,0.3);box-shadow:0 0 36px rgba(0,100,20,0.5);cursor:pointer;display:block;touch-action:none;}
#coaching-box{width:100%;max-width:600px;background:rgba(0,0,0,0.6);border:1px solid rgba(184,255,78,0.25);border-radius:9px;padding:8px 12px;min-height:44px;transition:border-color 0.3s;}
#coaching-box.good{border-color:var(--neon);}
#coaching-box.bad{border-color:var(--red);}
#coaching-title{font-size:8px;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px;}
#coaching-msg{font-size:12px;font-weight:700;line-height:1.4;}
.controls{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;max-width:600px;width:100%;}
.ctrl-btn{font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:11px;padding:7px 14px;border:none;border-radius:6px;cursor:pointer;}
#btn-start{background:var(--neon);color:var(--dark);font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;}
#btn-hint{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2);}
.legend{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;font-size:9px;color:rgba(255,255,255,0.4);max-width:600px;}
.legend-item{display:flex;align-items:center;gap:3px;}
.dot{width:8px;height:8px;border-radius:50%;}
.dot.a{background:var(--blue);}.dot.d{background:var(--red);}.dot.s{background:var(--orange);}

/* â”€â”€ IN-GAME TUTORIAL PANEL â”€â”€ */
#tut-panel{display:none;position:absolute;top:0;left:0;right:0;z-index:50;
  background:linear-gradient(180deg,rgba(4,16,8,0.97),rgba(4,16,8,0.93));
  border-bottom:2px solid var(--neon);border-radius:0 0 10px 10px;}
.tp-head{display:flex;align-items:center;gap:8px;padding:8px 12px 5px;border-bottom:1px solid rgba(255,255,255,0.06);}
.tp-icon{font-size:18px;}
.tp-title-text{font-weight:700;font-size:12px;color:var(--neon);flex:1;}
.tp-close{background:none;border:none;color:rgba(255,255,255,0.35);font-size:18px;cursor:pointer;line-height:1;padding:0 2px;}
.tp-step{padding:6px 12px;border-left:2px solid transparent;opacity:0.4;transition:all 0.25s;}
.tp-step.active{border-left-color:var(--neon);opacity:1;background:rgba(184,255,78,0.03);}
.tp-step.done{border-left-color:rgba(184,255,78,0.3);opacity:0.55;}
.tp-row{display:flex;gap:9px;align-items:flex-start;}
.ts-num{width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.4);font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.tp-step.done .ts-num{background:rgba(184,255,78,0.25);color:var(--neon);}
.tp-step.active .ts-num{background:var(--neon);color:var(--dark);}
.ts-title{font-weight:700;font-size:11px;margin-bottom:2px;}
.ts-desc{font-size:10px;color:rgba(255,255,255,0.6);line-height:1.5;}
.ts-mission{display:inline-block;margin-top:4px;padding:3px 9px;border-radius:5px;font-size:10px;font-weight:700;}
.ts-mission.offense{background:rgba(59,170,255,0.15);color:var(--blue);}
.ts-mission.defense{background:rgba(255,59,59,0.15);color:var(--red);}
.ts-prog{display:flex;align-items:center;gap:5px;margin-top:4px;}
.ts-prog-bar{flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;}
.ts-prog-fill{height:100%;border-radius:2px;transition:width 0.3s;}
.ts-prog-fill.offense{background:var(--blue);}
.ts-prog-fill.defense{background:var(--red);}
.ts-prog-lbl{font-size:9px;color:rgba(255,255,255,0.4);white-space:nowrap;}
.tp-done-area{padding:8px 12px 10px;text-align:center;border-top:1px solid rgba(255,255,255,0.06);}
.tp-done-msg{font-size:12px;font-weight:700;color:var(--neon);margin-bottom:7px;}
.tp-btn-next{background:var(--neon);color:var(--dark);font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;padding:7px 18px;border-radius:5px;cursor:pointer;border:none;font-weight:700;}
.tp-btn-free{background:transparent;color:rgba(255,255,255,0.35);font-size:10px;padding:5px 12px;border:1px solid rgba(255,255,255,0.12);border-radius:5px;cursor:pointer;margin-left:5px;}

/* â”€â”€ TUTORIAL LIST SECTION â”€â”€ */
.tut-side-tabs{display:flex;justify-content:center;background:rgba(0,0,0,0.4);border-bottom:1px solid rgba(255,255,255,0.07);}
.tst-btn{flex:1;max-width:130px;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:12px;padding:9px 0;border:none;background:transparent;color:rgba(255,255,255,0.35);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
.tst-btn.offense.active{color:var(--blue);border-bottom-color:var(--blue);}
.tst-btn.defense.active{color:var(--red);border-bottom-color:var(--red);}
.tut-list{padding:10px;max-width:600px;margin:0 auto;display:flex;flex-direction:column;gap:7px;}
.tlc{background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.1);border-radius:12px;display:flex;align-items:center;gap:12px;padding:13px 14px;cursor:pointer;transition:all 0.18s;}
.tlc:hover{background:rgba(255,255,255,0.06);border-color:rgba(255,255,255,0.2);}
.tlc.offense{border-left:3px solid var(--blue);}
.tlc.defense{border-left:3px solid var(--red);}
.tlc-icon{font-size:24px;flex-shrink:0;}
.tlc-body{flex:1;}
.tlc-title{font-weight:700;font-size:13px;}
.tlc-sub{font-size:10px;color:rgba(255,255,255,0.45);margin-top:3px;line-height:1.4;}
.tlc-badge{font-size:9px;padding:2px 8px;border-radius:9px;font-weight:700;flex-shrink:0;}
.offense .tlc-badge{background:rgba(59,170,255,0.2);color:var(--blue);}
.defense .tlc-badge{background:rgba(255,59,59,0.2);color:var(--red);}

/* â”€â”€ POPUPS â”€â”€ */
.popup{position:absolute;font-family:'Orbitron',sans-serif;font-size:13px;font-weight:900;pointer-events:none;animation:popFloat 1.1s ease-out forwards;white-space:nowrap;text-shadow:0 2px 8px rgba(0,0,0,0.6);}
@keyframes popFloat{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-44px) scale(1.15);}}
.through-banner{position:absolute;left:50%;top:38%;transform:translate(-50%,-50%) scale(0.5);background:linear-gradient(135deg,#ffe600,#ff9500);color:#1a1a00;font-family:'Orbitron',sans-serif;font-size:clamp(11px,2.8vw,19px);font-weight:900;padding:6px 18px;border-radius:26px;pointer-events:none;white-space:nowrap;letter-spacing:2px;box-shadow:0 4px 22px rgba(255,180,0,0.7);animation:bannerPop 1.8s ease-out forwards;z-index:10;}
@keyframes bannerPop{0%{opacity:0;transform:translate(-50%,-50%) scale(0.4) rotate(-4deg);}15%{opacity:1;transform:translate(-50%,-50%) scale(1.06) rotate(2deg);}45%{transform:translate(-50%,-50%) scale(1.01);}70%{opacity:1;}100%{opacity:0;transform:translate(-50%,-60%) scale(0.95);}}
.star-p{position:absolute;font-size:15px;pointer-events:none;animation:starFly 1.4s ease-out forwards;}
@keyframes starFly{0%{opacity:1;transform:translate(0,0);}100%{opacity:0;transform:var(--ft);}}
.step-flash{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(184,255,78,0.93);color:var(--dark);font-family:'Orbitron',sans-serif;font-size:clamp(12px,3.5vw,19px);font-weight:900;padding:9px 22px;border-radius:24px;pointer-events:none;animation:flashAnim 1.5s ease-out forwards;z-index:60;white-space:nowrap;}
@keyframes flashAnim{0%{opacity:0;transform:translate(-50%,-50%) scale(0.6);}20%{opacity:1;transform:translate(-50%,-50%) scale(1.04);}70%{opacity:1;}100%{opacity:0;transform:translate(-50%,-62%) scale(1);}}
</style>
</head>
<body>

<header>
  <h1>âš½ é³¥ã‹ã”ãƒã‚¹ã‚¿ãƒ¼</h1>
  <p>ãƒ‘ã‚¹ãƒ»ä½“ã®å‘ããƒ»ãƒ•ã‚©ãƒ­ãƒ¼ã®å‹•ãã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</p>
</header>

<div class="main-tabs">
  <button class="main-tab active" id="tab-play" onclick="switchTab('play')">âš½ ãƒ—ãƒ¬ã‚¤</button>
  <button class="main-tab" id="tab-tutorial" onclick="switchTab('tutorial')">ğŸ“– ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
</div>

<!-- â•â• PLAY SECTION â•â• -->
<div class="section visible" id="sec-play">
  <div class="mode-bar">
    <button class="mode-btn" id="mode-4v1" onclick="setMode('4v1')">4 vs 1</button>
    <button class="mode-btn active" id="mode-4v2" onclick="setMode('4v2')">4 vs 2</button>
    <button class="mode-btn" id="mode-5v2" onclick="setMode('5v2')">5 vs 2</button>
  </div>
  <div class="stats-bar">
    <div class="stat"><div class="lbl">ãƒ‘ã‚¹æˆåŠŸ</div><div class="val blue" id="stat-pass">0</div></div>
    <div class="stat timer-wrap">
      <div><div class="lbl">æ®‹ã‚Šæ™‚é–“</div><div class="val" id="stat-time">60</div></div>
      <div id="timer-bar"><div id="timer-fill"></div></div>
    </div>
    <div class="stat"><div class="lbl">ã‚«ãƒƒãƒˆ</div><div class="val red" id="stat-cut">0</div></div>
    <div class="stat"><div class="lbl">ãƒ¬ãƒ™ãƒ«</div><div class="val" id="stat-level">1</div></div>
  </div>
  <div class="game-wrapper">
    <div id="field-container">
      <canvas id="field"></canvas>
      <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚²ãƒ¼ãƒ å†…ãƒ‘ãƒãƒ« -->
      <div id="tut-panel">
        <div class="tp-head">
          <span class="tp-icon" id="tp-icon"></span>
          <span class="tp-title-text" id="tp-title-text"></span>
          <button class="tp-close" onclick="closeTutPanel()">âœ•</button>
        </div>
        <div id="tp-steps-wrap"></div>
        <div class="tp-done-area" id="tp-done-area" style="display:none">
          <div class="tp-done-msg" id="tp-done-msg"></div>
          <button class="tp-btn-next" id="tp-btn-next">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’</button>
          <button class="tp-btn-free" onclick="closeTutPanel()">è‡ªç”±ç·´ç¿’ã¸</button>
        </div>
      </div>
    </div>
    <div id="coaching-box">
      <div id="coaching-title">ã‚³ãƒ¼ãƒãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ</div>
      <div id="coaching-msg">ãƒ‘ã‚¹ã—ãŸã„é¸æ‰‹ï¼ˆé’ï¼‰ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ï¼</div>
    </div>
    <div class="controls">
      <button class="ctrl-btn" id="btn-start">â–¶ å†ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="ctrl-btn" id="btn-hint">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="dot a"></div>æ”»æ’ƒè€…</div>
      <div class="legend-item"><div class="dot d"></div>å®ˆå‚™è€…</div>
      <div class="legend-item"><div class="dot s"></div>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</div>
    </div>
  </div>
</div>

<!-- â•â• TUTORIAL SECTION â•â• -->
<div class="section" id="sec-tutorial">
  <div class="tut-side-tabs">
    <button class="tst-btn offense active" id="tst-offense" onclick="switchTutSide('offense')">âš”ï¸ æ”»æ’ƒ</button>
    <button class="tst-btn defense" id="tst-defense" onclick="switchTutSide('defense')">ğŸ›¡ï¸ å®ˆå‚™</button>
  </div>
  <div class="tut-list" id="tut-list-offense"></div>
  <div class="tut-list" id="tut-list-defense" style="display:none"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TUTORIAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var LESSONS = {
  offense: [
    {
      id:'body_angle', icon:'ğŸ‘€', badge:'åŸºæœ¬', mode:'4v1',
      title:'ä½“ã®å‘ãï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ã§å—ã‘ã‚ˆã†ï¼‰',
      sub:'ãƒ‘ã‚¹ã‚’ã‚‚ã‚‰ã†å‰ã‹ã‚‰2ã¤ã®é¸æŠè‚¢ã‚’æŒã¤',
      steps:[
        { title:'ãªãœä½“ã®å‘ããŒå¤§äº‹ï¼Ÿ',
          desc:'ãƒœãƒ¼ãƒ«ã‚’å—ã‘ã‚‹ã¨ãã€ŒèƒŒä¸­ã‚’å‘ã‘ã¦ã„ã‚‹ï¼ˆCLOSEï¼‰ã€ã¨æ¬¡ã®ãƒ‘ã‚¹ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚\nåŠèº«ï¼ˆOPENï¼‰ã§å—ã‘ã‚Œã°å·¦å³ã©ã¡ã‚‰ã«ã‚‚ç´ æ—©ããƒ‘ã‚¹ã§ãã‚‹ã‚ˆã€‚',
          mission:{ text:'ç·‘ã®çŸ¢å°ï¼ˆOPENï¼‰ã®é¸æ‰‹ã«3å›ãƒ‘ã‚¹ã—ã‚ˆã†', side:'offense', goal:3, event:'open_pass' } },
        { title:'2ã¤ã®ã‚³ãƒ¼ã‚¹ã‚’è¦‹ã¦ã‹ã‚‰å—ã‘ã‚ˆã†',
          desc:'ãƒ‘ã‚¹ã‚’ã‚‚ã‚‰ã†å‰ã«ã€æ¬¡ã«ãƒ‘ã‚¹ã§ãã‚‹å…ˆã‚’2ã¤ç¢ºèªã—ã‚ˆã†ã€‚\nå—ã‘ãŸç¬é–“ã«è¿·ã‚ãªãã¦æ¸ˆã‚€ï¼',
          mission:{ text:'OPENã®é¸æ‰‹ã¸ã®é€£ç¶šãƒ‘ã‚¹ã‚’5å›æˆåŠŸã•ã›ã‚ˆã†', side:'offense', goal:5, event:'open_pass' } },
        { title:'ã¾ã¨ã‚ï¼šç·‘ã®çŸ¢å°ã‚’å„ªå…ˆã—ã‚ˆã†',
          desc:'ãƒ»ãƒœãƒ¼ãƒ«ãŒæ¥ã‚‹å‰ã«ä½“ã‚’ã²ã‚‰ã\nãƒ»ç·‘ã®çŸ¢å° = 2ã‚³ãƒ¼ã‚¹è¦‹ãˆã¦ã‚‹ = é€Ÿã„ãƒ—ãƒ¬ãƒ¼\nãƒ»èµ¤ã®çŸ¢å° = èƒŒä¸­å‘ã = é…ã„ãƒ—ãƒ¬ãƒ¼',
          mission:{ text:'10æœ¬ãƒ‘ã‚¹ã‚’ç¹‹ã’ã¦ã¿ã‚ˆã†ï¼', side:'offense', goal:10, event:'any_pass' } }
      ]
    },
    {
      id:'pass_course', icon:'ğŸ”º', badge:'åŸºæœ¬', mode:'4v2',
      title:'ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’è¤‡æ•°ã¤ãã‚‹ï¼ˆä¸‰è§’å½¢ï¼‰',
      sub:'å¸¸ã«2ã€œ3ã®é¸æŠè‚¢ã‚’ä½œã‚‹ã“ã¨ãŒé³¥ã‹ã”ã®åŸºæœ¬',
      steps:[
        { title:'ä¸‰è§’å½¢ã§ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’ä½œã‚ã†',
          desc:'ãƒœãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã‚‹é¸æ‰‹ã‚’é ‚ç‚¹ã«ã—ã¦ã€ä»²é–“ãŒä¸‰è§’å½¢ã®ä½ç½®ã«ç«‹ã¤ã¨2ã‚³ãƒ¼ã‚¹ã§ãã‚‹ã€‚\nç·‘ã®ç‚¹ç·šãŒ2æœ¬ä»¥ä¸Šã‚ã‚Œã°ç†æƒ³çš„ï¼',
          mission:{ text:'ç·‘ã®ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ãŒ2æœ¬ã‚ã‚‹çŠ¶æ…‹ã§ãƒ‘ã‚¹ã—ã‚ˆã†ï¼ˆ3å›ï¼‰', side:'offense', goal:3, event:'multi_open_pass' } },
        { title:'Dã®é–“ã‚’é€šã™ãƒ‘ã‚¹',
          desc:'D2äººã®é–“ã«ãƒ‘ã‚¹ãŒé€šã‚‹ã¨ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸&ã‚«ãƒãƒ¼ã®éšŠå½¢ãŒå´©ã‚Œã‚‹ã€‚\nç©æ¥µçš„ã«ç‹™ã£ã¦ã¿ã‚ˆã†ï¼',
          mission:{ text:'Dã®é–“ã‚’é€šã™ã‚¹ãƒ«ãƒ¼ãƒ‘ã‚¹ã‚’1å›æˆåŠŸã•ã›ã‚ˆã†', side:'offense', goal:1, event:'through_pass' } },
        { title:'ä¸€ç›´ç·šã¯NG',
          desc:'ä»²é–“ãŒä¸€ç›´ç·šã«ä¸¦ã¶ã¨1äººã®Dã§2ã‚³ãƒ¼ã‚¹å¡ã’ã¦ã—ã¾ã†ã€‚\nä¸‰è§’å½¢ãƒ»æ–œã‚ã®é–¢ä¿‚ã‚’æ„è­˜ã—ã‚ˆã†ã€‚',
          mission:{ text:'ã‚«ãƒƒãƒˆã•ã‚Œãšã«8æœ¬ãƒ‘ã‚¹ã‚’ç¹‹ã”ã†', side:'offense', goal:8, event:'no_cut_pass' } }
      ]
    },
    {
      id:'follow', icon:'ğŸŸ ', badge:'å¿œç”¨', mode:'4v2',
      title:'ãƒ•ã‚©ãƒ­ãƒ¼ã®å‹•ãï¼ˆå‘³æ–¹ã‚’åŠ©ã‘ã‚ˆã†ï¼‰',
      sub:'å›°ã£ã¦ã„ã‚‹ä»²é–“ã®ãã°ã«å‹•ã„ã¦ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’ã¤ãã‚‹',
      steps:[
        { title:'ãƒ•ã‚©ãƒ­ãƒ¼ãŒå¿…è¦ãªå ´é¢',
          desc:'Dã«è¿½ã„è¾¼ã¾ã‚Œã¦ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ãŒãªããªã£ãŸã¨ãã€éš£ã®ä»²é–“ãŒå‹•ã„ã¦ã‚³ãƒ¼ã‚¹ã‚’ä½œã£ã¦ãã‚Œã‚‹ã€‚\nã‚ªãƒ¬ãƒ³ã‚¸ã®ã€ŒRUNï¼ã€ãŒå‹•ã„ãŸã‚‰ãƒãƒ£ãƒ³ã‚¹ï¼',
          mission:{ text:'ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ã®ä»²é–“ã«ãƒ‘ã‚¹ã—ã‚ˆã†ï¼ˆ2å›ï¼‰', side:'offense', goal:2, event:'pass_to_follow' } },
        { title:'ãƒ•ã‚©ãƒ­ãƒ¼å¾Œã¯ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹',
          desc:'ãƒ‘ã‚¹ãŒé€šã£ãŸã‚ã¨ã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸé¸æ‰‹ãŒå…ƒã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹ã€‚\nå››è§’å½¢ã®å½¢ã‚’ä¿ã¤ã“ã¨ã§æ¬¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ãŒå¸¸ã«ã‚ã‚‹çŠ¶æ…‹ã«ãªã‚‹ã‚ˆã€‚',
          mission:{ text:'ãƒ•ã‚©ãƒ­ãƒ¼è¾¼ã¿ã§10æœ¬ãƒ‘ã‚¹ã‚’ç¹‹ã”ã†', side:'offense', goal:10, event:'any_pass' } }
      ]
    }
  ],
  defense: [
    {
      id:'challenge_cover', icon:'ğŸ›¡ï¸', badge:'åŸºæœ¬', mode:'4v2',
      title:'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼†ã‚«ãƒãƒ¼',
      sub:'2äººã§é€£æºã—ã¦å®ˆã‚‹ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ã®åŸºæœ¬',
      steps:[
        { title:'C1ï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼ï¼‰ã®å½¹å‰²',
          desc:'C1ã¯ç›´ç·šçš„ã«çªã£è¾¼ã¾ãªã„ã€‚\nç›¸æ‰‹ã®é¸æŠè‚¢ã‚’åˆ¶é™ã—ãªãŒã‚‰æ–œã‚ã‹ã‚‰å¯„ã›ã‚‹ã€‚\nèµ¤ã„æ‰‡å½¢ãŒC1ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚¾ãƒ¼ãƒ³ã€‚ã‚³ãƒ¼ã‚¹ã‚’çµã£ã¦ã„ã‚‹ã®ã‚’ç¢ºèªã—ã‚ˆã†ã€‚',
          mission:{ text:'ã‚²ãƒ¼ãƒ ã‚’è¦³å¯Ÿã—ã¦ãƒ‘ã‚¹ã‚’5æœ¬è¦‹ã‚ˆã†ï¼ˆC1ã®å‹•ãã‚’ãƒã‚§ãƒƒã‚¯ï¼‰', side:'defense', goal:5, event:'any_pass' } },
        { title:'C2ï¼ˆã‚«ãƒãƒ¼ï¼‰ã®å½¹å‰²',
          desc:'C2ã¯C1ãŒå¡ã’ãªã„ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’ã‚«ãƒãƒ¼ã™ã‚‹ã€‚\nC1ã¨C2ã§ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’åˆ†æ‹…ã—ã¦å®ˆã£ã¦ã„ã‚‹ã®ãŒç”»é¢ã§ç¢ºèªã§ãã‚‹ã€‚',
          mission:{ text:'D2äººã§ãƒ‘ã‚¹ã‚’ã‚«ãƒƒãƒˆã—ã‚ˆã†ï¼ˆ1å›ï¼‰', side:'defense', goal:1, event:'cut' } },
        { title:'é€£ä¿‚ã—ã¦è¿½ã„è¾¼ã‚‚ã†',
          desc:'C1ãŒå¯„ã›ã¦C2ãŒã‚«ãƒãƒ¼ â†’ æ”»æ’ƒå´ã®é¸æŠè‚¢ãŒæ¸›ã‚‹ã€‚\n2äººãŒé€£å‹•ã™ã‚‹ã¨ã€ã‚¹ãƒ«ãƒ¼ãƒ‘ã‚¹ã‚‚é€šã—ã«ãããªã‚‹ã€‚',
          mission:{ text:'ãƒ‘ã‚¹ã‚’3å›ã‚«ãƒƒãƒˆã—ã‚ˆã†', side:'defense', goal:3, event:'cut' } }
      ]
    },
    {
      id:'intercept', icon:'âš¡', badge:'å¿œç”¨', mode:'4v2',
      title:'ãƒ‘ã‚¹ã‚«ãƒƒãƒˆï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆï¼‰',
      sub:'ãƒ‘ã‚¹ã®çµŒè·¯ã«å…ˆã«å…¥ã£ã¦ãƒœãƒ¼ãƒ«ã‚’å¥ªã†',
      steps:[
        { title:'ã‚«ãƒƒãƒˆã§ãã‚‹çŠ¶æ³ã‚’è¦‹æ¥µã‚ã‚‹',
          desc:'èµ¤ã„ç‚¹ç·šã®ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ = DãŒã™ã§ã«é‚ªé­”ã‚’ã—ã¦ã„ã‚‹ã€‚\nDãŒãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ã«ç«‹ã¦ã¦ã„ã‚‹ã¨ãã€ç›¸æ‰‹ãŒãã®ã‚³ãƒ¼ã‚¹ã«å‡ºã—ãŸã‚‰å¥ªãˆã‚‹ï¼',
          mission:{ text:'ãƒ‘ã‚¹ã‚’ã‚«ãƒƒãƒˆã—ã‚ˆã†ï¼ˆ1å›ï¼‰', side:'defense', goal:1, event:'cut' } },
        { title:'ã‚«ãƒãƒ¼ãŒã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã‚’ç‹™ã†',
          desc:'C1ãŒå¯„ã›ã‚‹ã¨ã€ç›¸æ‰‹ã¯C2ãŒå®ˆã£ã¦ã„ã‚‹ã‚³ãƒ¼ã‚¹ã«ãƒ‘ã‚¹ã—ãŒã¡ã€‚\nC2ãŒãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ä¸Šã«ç«‹ã¦ã¦ã„ã‚Œã°ã€ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã®ãƒãƒ£ãƒ³ã‚¹ï¼',
          mission:{ text:'åˆè¨ˆ3å›ã‚«ãƒƒãƒˆã—ã‚ˆã†', side:'defense', goal:3, event:'cut' } }
      ]
    },
    {
      id:'transition', icon:'ğŸ”„', badge:'å¿œç”¨', mode:'4v2',
      title:'æ”»å®ˆã®åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ï¼‰',
      sub:'å¥ªã£ãŸã‚‰å³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã€å¥ªã‚ã‚ŒãŸã‚‰å³ãƒ—ãƒ¬ã‚¹',
      steps:[
        { title:'å®ˆâ†’æ”»ï¼šå¥ªã£ãŸã‚‰ç´ æ—©ã',
          desc:'ãƒœãƒ¼ãƒ«ã‚’å¥ªã£ãŸã‚‰ï¼ˆã‚«ãƒƒãƒˆã—ãŸã‚‰ï¼‰ã™ãã«ãƒ‘ã‚¹ã‚’ã¤ãªã”ã†ã€‚\nDFãŒå‰ã«å‡ºã¦ã„ã‚‹ã‚¹ã‚­ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§ãã‚‹ï¼',
          mission:{ text:'ã‚«ãƒƒãƒˆå¾Œã®ã‚²ãƒ¼ãƒ ã§ãƒ‘ã‚¹ã‚’5æœ¬ç¹‹ã’ã‚ˆã†', side:'defense', goal:5, event:'any_pass' } },
        { title:'æ”»â†’å®ˆï¼šå–ã‚‰ã‚ŒãŸã‚‰ã™ããƒ—ãƒ¬ã‚¹',
          desc:'ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã•ã‚ŒãŸã‚‰ã€ãã®ç¬é–“ã«2äººã§ãƒ—ãƒ¬ã‚¹ã‚’ã‹ã‘ã‚‹ã€‚\nC1ã¨C2ãŒã™ãã«å‹•ãå‡ºã™ç”»é¢ã‚’è¦³å¯Ÿã—ã‚ˆã†ã€‚',
          mission:{ text:'åˆè¨ˆ5å›ã‚«ãƒƒãƒˆã—ã‚ˆã†', side:'defense', goal:5, event:'cut' } }
      ]
    }
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var currentTab = 'play';

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-play').classList.toggle('active', tab === 'play');
  document.getElementById('tab-tutorial').classList.toggle('active', tab === 'tutorial');
  document.getElementById('sec-play').classList.toggle('visible', tab === 'play');
  document.getElementById('sec-tutorial').classList.toggle('visible', tab === 'tutorial');
  // canvasã®ãƒªã‚µã‚¤ã‚ºï¼ˆplayè¡¨ç¤ºæ™‚ï¼‰
  if (tab === 'play') {
    setTimeout(function(){ resize(); draw(); }, 10);
  }
}

function switchTutSide(side) {
  document.getElementById('tst-offense').classList.toggle('active', side === 'offense');
  document.getElementById('tst-defense').classList.toggle('active', side === 'defense');
  document.getElementById('tut-list-offense').style.display = side === 'offense' ? '' : 'none';
  document.getElementById('tut-list-defense').style.display = side === 'defense' ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TUTORIAL LIST RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLessons() {
  ['offense', 'defense'].forEach(function(side) {
    var list = document.getElementById('tut-list-' + side);
    list.innerHTML = '';
    LESSONS[side].forEach(function(lesson, idx) {
      var div = document.createElement('div');
      div.className = 'tlc ' + side;
      div.innerHTML =
        '<span class="tlc-icon">' + lesson.icon + '</span>' +
        '<div class="tlc-body">' +
          '<div class="tlc-title">' + lesson.title + '</div>' +
          '<div class="tlc-sub">' + lesson.sub + '</div>' +
        '</div>' +
        '<span class="tlc-badge">' + lesson.badge + '</span>';
      (function(s, i) {
        div.onclick = function() { startLesson(s, i); };
      })(side, idx);
      list.appendChild(div);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TUTORIAL STATE & PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var tutState = { active: false };

function startLesson(side, idx) {
  var lesson = LESSONS[side][idx];
  tutState = { active: true, side: side, lessonIdx: idx, stepIdx: 0, progress: 0, lesson: lesson };

  // ãƒ¢ãƒ¼ãƒ‰è¨­å®š
  gameMode = lesson.mode;
  ['4v1','4v2','5v2'].forEach(function(k) {
    document.getElementById('mode-' + k).classList.toggle('active', k === gameMode);
  });

  // ãƒ—ãƒ¬ã‚¤ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‹ã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
  switchTab('play');
  setTimeout(function() {
    restartGame();
    renderTutPanel();
  }, 60);
}

function renderTutPanel() {
  if (!tutState.active) return;
  var lesson = tutState.lesson;
  var stepIdx = tutState.stepIdx;
  var side = tutState.side;

  document.getElementById('tp-icon').textContent = lesson.icon;
  document.getElementById('tp-title-text').textContent = lesson.title;
  document.getElementById('tp-done-area').style.display = 'none';

  var wrap = document.getElementById('tp-steps-wrap');
  wrap.innerHTML = '';
  lesson.steps.forEach(function(s, i) {
    var div = document.createElement('div');
    var stateClass = i < stepIdx ? 'done' : i === stepIdx ? 'active' : '';
    div.className = 'tp-step ' + stateClass;

    var prog = (i === stepIdx) ? tutState.progress : (i < stepIdx ? s.mission.goal : 0);
    var pct  = Math.min(100, Math.round(prog / s.mission.goal * 100));

    var inner = '<div class="tp-row">' +
      '<div class="ts-num">' + (i < stepIdx ? 'âœ“' : i + 1) + '</div>' +
      '<div>';
    inner += '<div class="ts-title">' + s.title + '</div>';
    if (i === stepIdx) {
      inner += '<div class="ts-desc">' + s.desc.replace(/\n/g, '<br>') + '</div>';
      inner += '<div class="ts-mission ' + side + '">ğŸ¯ ' + s.mission.text + '</div>';
      inner += '<div class="ts-prog">' +
        '<div class="ts-prog-bar"><div class="ts-prog-fill ' + side + '" style="width:' + pct + '%"></div></div>' +
        '<span class="ts-prog-lbl">' + prog + ' / ' + s.mission.goal + '</span>' +
        '</div>';
    }
    inner += '</div></div>';
    div.innerHTML = inner;
    wrap.appendChild(div);
  });

  document.getElementById('tut-panel').style.display = 'block';
  if (!tutState.active) return;
  setCoaching('ğŸ¯ ' + lesson.steps[stepIdx].mission.text, '');
}

function stepComplete() {
  var lesson = tutState.lesson;
  var stepIdx = tutState.stepIdx;
  var side = tutState.side;

  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  var flash = document.createElement('div');
  flash.className = 'step-flash';
  var isLast = stepIdx >= lesson.steps.length - 1;
  flash.textContent = isLast ? 'ãƒ¬ãƒƒã‚¹ãƒ³å®Œäº†ï¼ ğŸ‰' : 'ã‚¹ãƒ†ãƒƒãƒ—ã‚¯ãƒªã‚¢ï¼ âœ…';
  document.getElementById('field-container').appendChild(flash);
  setTimeout(function() { if (flash.parentNode) flash.parentNode.removeChild(flash); }, 1600);

  var doneArea = document.getElementById('tp-done-area');
  var btnNext  = document.getElementById('tp-btn-next');

  if (!isLast) {
    document.getElementById('tp-done-msg').textContent = 'âœ… ã‚¯ãƒªã‚¢ï¼æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚‚ã†';
    btnNext.textContent = 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— â†’';
    btnNext.onclick = function() {
      tutState.stepIdx++;
      tutState.progress = 0;
      restartGame();
      renderTutPanel();
    };
  } else {
    document.getElementById('tp-done-msg').textContent = 'ğŸ‰ã€Œ' + lesson.title + 'ã€å®Œäº†ï¼';
    var nextIdx = tutState.lessonIdx + 1;
    var hasNext = nextIdx < LESSONS[side].length;
    btnNext.textContent = hasNext ? 'æ¬¡ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¸ â†’' : 'ä¸€è¦§ã«æˆ»ã‚‹';
    btnNext.onclick = function() {
      closeTutPanel();
      switchTab('tutorial');
      if (hasNext) {
        setTimeout(function() { startLesson(side, nextIdx); }, 80);
      }
    };
  }
  doneArea.style.display = 'block';
}

function closeTutPanel() {
  tutState = { active: false };
  document.getElementById('tut-panel').style.display = 'none';
  setCoaching(isWedgeMode() ? '5ç•ªï¼ˆä¸­å¤®ï¼‰ã«ãã•ã³ãƒ‘ã‚¹ã‚’å…¥ã‚Œã‚ˆã†ï¼' : 'ãƒ‘ã‚¹ã—ãŸã„é¸æ‰‹ï¼ˆé’ï¼‰ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ï¼', '');
}

// â”€â”€ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ â”€â”€
function tutEvent(event) {
  if (!tutState.active) return;
  var m = tutState.lesson.steps[tutState.stepIdx].mission;

  var match = false;
  if (m.event === event) {
    match = true;
  } else if (m.event === 'any_pass' &&
    (event === 'open_pass' || event === 'closed_pass' || event === 'through_pass' ||
     event === 'multi_open_pass' || event === 'pass_to_follow')) {
    match = true;
  } else if (m.event === 'no_cut_pass' &&
    (event === 'open_pass' || event === 'closed_pass')) {
    match = true;
  }

  if (match) {
    tutState.progress++;
    renderTutPanel();
    if (tutState.progress >= m.goal) stepComplete();
  }
}

function tutCutEvent() {
  if (!tutState.active) return;
  var m = tutState.lesson.steps[tutState.stepIdx].mission;
  if (m.event === 'cut') {
    tutState.progress++;
    renderTutPanel();
    if (tutState.progress >= m.goal) stepComplete();
  }
  if (m.event === 'no_cut_pass') {
    tutState.progress = 0;
    renderTutPanel();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var canvas = document.getElementById('field');
var ctx    = canvas.getContext('2d');
var gameMode = '4v2';

function numDef()      { return gameMode === '4v1' ? 1 : 2; }
function numAtt()      { return gameMode === '5v2' ? 5 : 4; }
function isWedgeMode() { return gameMode === '5v2'; }

function resize() {
  var cont = document.getElementById('field-container');
  var w = Math.min(cont.clientWidth || 360, 600);
  if (w < 50) w = Math.min(window.innerWidth - 20, 600);
  canvas.width  = w;
  canvas.height = Math.round(w * 0.72);
}
window.addEventListener('resize', function() { resize(); draw(); });

var state = {
  phase:'idle', passes:0, cuts:0, level:1, time:60,
  timerInterval:null, ball:{owner:0,x:0,y:0,moving:false}, lastFollowTime:0,
  wedgeTimer:null
};
var attackers=[], defenders=[], animFrame=null, defLoop=null;

var TIPS = {
  open:   ['âœ… ã‚°ãƒƒãƒ‰ï¼ã‚ªãƒ¼ãƒ—ãƒ³ãªä½“ã®å‘ãã§å—ã‘ãŸï¼','âœ… ãƒŠã‚¤ã‚¹ï¼åŠèº«ã§å—ã‘ã¦æ¬¡ã®ãƒ—ãƒ¬ãƒ¼ãŒé€Ÿã„ï¼'],
  closed: ['âš ï¸ ä½“ãŒé–‰ã˜ã¦ã‚‹ï¼æ¬¡ã¯åŠèº«ï¼ˆOPENï¼‰ã§å—ã‘ã‚ˆã†'],
  cut:    ['âŒ ã‚«ãƒƒãƒˆã•ã‚ŒãŸï¼ã‚‚ã£ã¨æ—©ã‚ã«ãƒ‘ã‚¹ã—ã‚ˆã†','âŒ ãƒ‘ã‚¹ã‚³ãƒ¼ã‚¹ã‚’èª­ã¾ã‚ŒãŸï¼'],
  follow: ['ğŸŸ  ãƒ•ã‚©ãƒ­ãƒ¼ï¼ä»²é–“ãŒã‚µãƒãƒ¼ãƒˆã«èµ°ã£ãŸï¼','ğŸŸ  ãƒŠã‚¤ã‚¹ãƒ•ã‚©ãƒ­ãƒ¼ï¼ä¸‰è§’å½¢ã§ã‚³ãƒ¼ã‚¹ãŒå¢—ãˆãŸï¼'],
  levelup:['ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ãŒé€Ÿããªã‚‹ã‚ˆï¼'],
  wedge:  ['ğŸ”· ãã•ã³ãƒ‘ã‚¹ï¼5ç•ªãŒDã®é–“ã§å—ã‘ãŸï¼'],
  layoff: ['ğŸ”· ãƒŠã‚¤ã‚¹ã¯ãŸãï¼ãã•ã³ã‹ã‚‰ç´ æ—©ãå±•é–‹ï¼'],
};
function rand(a) { return a[Math.floor(Math.random()*a.length)]; }

function setCoaching(msg, cls) {
  document.getElementById('coaching-box').className = cls || '';
  document.getElementById('coaching-msg').textContent = msg;
}
function updateStats() {
  document.getElementById('stat-pass').textContent  = state.passes;
  document.getElementById('stat-cut').textContent   = state.cuts;
  document.getElementById('stat-level').textContent = state.level;
}

var NEIGHBORS = {0:[1,3],1:[0,2],2:[1,3],3:[0,2],4:[0,1,2,3]};

function getHomes() {
  var W=canvas.width,H=canvas.height,mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
  return [
    {x:mx+fw*.15,y:my+fh*.2},{x:mx+fw*.85,y:my+fh*.2},
    {x:mx+fw*.85,y:my+fh*.8},{x:mx+fw*.15,y:my+fh*.8},
    {x:mx+fw*.5, y:my+fh*.5}
  ];
}

function initGame() {
  var homes = getHomes(), n = numAtt();
  attackers = homes.slice(0,n).map(function(h,i) {
    return {id:i,x:h.x,y:h.y,homeX:h.x,homeY:h.y,
            bodyAngle:0,openBody:i!==2,
            following:false,returningHome:false,followTarget:null,
            isWedge:isWedgeMode()&&i===4,wedgeState:'idle'};
  });
  var W=canvas.width,H=canvas.height,mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
  var spd = 1.2 + (state.level-1)*0.3;
  defenders = [{id:0,x:mx+fw*.38,y:my+fh*.45,speed:spd}];
  if (numDef()>=2) defenders.push({id:1,x:mx+fw*.62,y:my+fh*.55,speed:spd});
  state.ball = {owner:0,x:attackers[0].x,y:attackers[0].y,moving:false};
  state.phase = 'select';
  state.lastFollowTime = 0;
  randomBodyAngles(-1);
  if (!tutState.active) {
    setCoaching(isWedgeMode()?'5ç•ªï¼ˆä¸­å¤®ï¼‰ã«ãã•ã³ãƒ‘ã‚¹ã‚’å…¥ã‚Œã‚ˆã†ï¼':'ãƒ‘ã‚¹ã—ãŸã„é¸æ‰‹ï¼ˆé’ï¼‰ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ï¼','');
  }
}

function updateHomes() {
  var homes = getHomes();
  attackers.forEach(function(a){ a.homeX=homes[a.id].x; a.homeY=homes[a.id].y; });
}

function randomBodyAngles(exceptId) {
  var W=canvas.width,H=canvas.height;
  attackers.forEach(function(a){
    if (a.id===exceptId) return;
    var open = Math.random()>0.3; a.openBody=open;
    a.bodyAngle = open ? Math.atan2(H/2-a.y,W/2-a.x)+(Math.random()-.5)*.9
                       : Math.atan2(a.y-H/2,a.x-W/2)+(Math.random()-.5)*.6;
  });
}

// â”€â”€ Wedge â”€â”€
function updateWedge() {
  if (!isWedgeMode()) return;
  var wedge=null;
  for(var i=0;i<attackers.length;i++){if(attackers[i].isWedge){wedge=attackers[i];break;}}
  if (!wedge||wedge.id===state.ball.owner||wedge.following||wedge.returningHome) return;
  if (defenders.length<2) return;
  var W=canvas.width,H=canvas.height,mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
  var d0=defenders[0],d1=defenders[1];
  var gx=(d0.x+d1.x)/2,gy=(d0.y+d1.y)/2;
  var holder=attackers[state.ball.owner];
  var ang=Math.atan2(holder.y-gy,holder.x-gx);
  var off=Math.min(fw*.12,Math.hypot(holder.x-gx,holder.y-gy)*.3);
  var tx=Math.max(mx+20,Math.min(mx+fw-20,gx+Math.cos(ang)*off));
  var ty=Math.max(my+20,Math.min(my+fh-20,gy+Math.sin(ang)*off));
  var dx=tx-wedge.x,dy=ty-wedge.y,d=Math.hypot(dx,dy);
  if(d>6){wedge.x+=dx/d*1.6;wedge.y+=dy/d*1.6;}
  wedge.bodyAngle=Math.atan2(holder.y-wedge.y,holder.x-wedge.x)+(Math.random()-.5)*.15;
  wedge.openBody=true; wedge.wedgeState='open';
}

function triggerLayoff(wedgeId) {
  if (state.wedgeTimer) clearTimeout(state.wedgeTimer);
  var wedge=null;
  for(var i=0;i<attackers.length;i++){if(attackers[i].id===wedgeId){wedge=attackers[i];break;}}
  if (!wedge) return;
  wedge.wedgeState='receiving';
  state.wedgeTimer=setTimeout(function(){
    if (state.phase!=='select'||state.ball.owner!==wedgeId) return;
    var outer=attackers.filter(function(a){return !a.isWedge;});
    var best=null,bestScore=-Infinity;
    outer.forEach(function(a){
      if(isBlocked(wedge,a)) return;
      var dd=Math.min.apply(null,defenders.map(function(d){return segDist(d.x,d.y,wedge.x,wedge.y,a.x,a.y);}));
      var score=dd+Math.hypot(a.x-wedge.x,a.y-wedge.y)*.3;
      if(score>bestScore){bestScore=score;best=a;}
    });
    if(!best){outer.forEach(function(a){if(!best||Math.hypot(a.x-wedge.x,a.y-wedge.y)<Math.hypot(best.x-wedge.x,best.y-wedge.y))best=a;});}
    if(!best) return;
    wedge.wedgeState='layoff';
    showPopup('ã¯ãŸãï¼',wedge.x,wedge.y-28,'#b8ff4e');
    setCoaching(rand(TIPS.layoff),'good');
    doAnimate(wedge.x,wedge.y,best.x,best.y,best.id,true,false);
  },420);
}

// â”€â”€ Follow â”€â”€
function calcFollowTarget(mover,holder) {
  var W=canvas.width,H=canvas.height,mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
  var base=Math.atan2(mover.y-holder.y,mover.x-holder.x);
  var bx=mover.x,by=mover.y,bd=-1;
  for(var da=-0.7;da<=0.7;da+=0.2){
    var cx=Math.max(mx+20,Math.min(mx+fw-20,holder.x+Math.cos(base+da)*fw*.28));
    var cy=Math.max(my+20,Math.min(my+fh-20,holder.y+Math.sin(base+da)*fw*.28));
    var md=Infinity;
    defenders.forEach(function(d){md=Math.min(md,Math.hypot(d.x-cx,d.y-cy));});
    if(md>bd){bd=md;bx=cx;by=cy;}
  }
  return {x:bx,y:by};
}

function normAngle(a){while(a>Math.PI)a-=2*Math.PI;while(a<-Math.PI)a+=2*Math.PI;return a;}

function checkFollow() {
  if(state.phase!=='select') return;
  var holder=attackers[state.ball.owner];
  var W=canvas.width,closest=Infinity,closestAng=0;
  defenders.forEach(function(d){
    var dist=Math.hypot(d.x-holder.x,d.y-holder.y);
    if(dist<closest){closest=dist;closestAng=Math.atan2(d.y-holder.y,d.x-holder.x);}
  });
  if(closest>W*.21){returnHome();return;}
  var now=performance.now();
  if(now-state.lastFollowTime<1800) return;
  state.lastFollowTime=now;
  var nids=NEIGHBORS[state.ball.owner]||[];
  var cands=[];
  nids.forEach(function(id){
    var a=null;
    for(var i=0;i<attackers.length;i++){if(attackers[i].id===id){a=attackers[i];break;}}
    if(a&&!a.following&&!a.returningHome&&!a.isWedge) cands.push(a);
  });
  if(!cands.length) return;
  var best=cands[0],bs=-Infinity;
  cands.forEach(function(a){
    var ang=Math.atan2(a.y-holder.y,a.x-holder.x);
    var sc=Math.PI-Math.abs(normAngle(ang-closestAng-Math.PI));
    if(sc>bs){bs=sc;best=a;}
  });
  best.following=true; best.returningHome=false;
  best.followTarget=calcFollowTarget(best,holder);
  setCoaching(rand(TIPS.follow),'good');
  showPopup('ãƒ•ã‚©ãƒ­ãƒ¼ï¼',best.x,best.y-26,'#ff9500');
}

function returnHome() {
  attackers.forEach(function(a){
    if(a.id===state.ball.owner||a.isWedge) return;
    if(a.following){a.following=false;a.returningHome=true;a.followTarget={x:a.homeX,y:a.homeY};}
  });
}

function moveFollowers() {
  attackers.forEach(function(a){
    if(a.id===state.ball.owner||(!a.following&&!a.returningHome)||!a.followTarget) return;
    var dx=a.followTarget.x-a.x,dy=a.followTarget.y-a.y,d=Math.hypot(dx,dy);
    var sp=a.returningHome?1.8:2.8;
    if(d>4){a.x+=dx/d*sp;a.y+=dy/d*sp;}
    else{
      a.x=a.followTarget.x;a.y=a.followTarget.y;
      if(a.returningHome){a.returningHome=false;a.followTarget=null;}
      else{a.following=false;}
    }
  });
}

// â”€â”€ Defenders â”€â”€
function updateDefs() {
  if(state.phase!=='select') return;
  var holder=attackers[state.ball.owner];
  if(numDef()===1){
    var d=defenders[0],dx=holder.x-d.x,dy=holder.y-d.y,dist=Math.hypot(dx,dy);
    if(dist>5){d.x+=dx/dist*d.speed;d.y+=dy/dist*d.speed;}
    if(dist<18) doIntercept();
  } else {
    var ch=defenders[0],cv=defenders[1];
    var free=attackers.filter(function(a){return a.id!==state.ball.owner;});
    var mo=free[0],md=-1;
    free.forEach(function(a){var s=segDist(cv.x,cv.y,holder.x,holder.y,a.x,a.y);if(s>md){md=s;mo=a;}});
    var openAng=Math.atan2(mo.y-holder.y,mo.x-holder.x);
    var cd=Math.hypot(holder.x-ch.x,holder.y-ch.y);
    var aoff=Math.min(0.55,(cd/(canvas.width*.5))*.9);
    var aang=openAng+Math.PI+aoff;
    var rp=Math.max(20,cd*.15);
    var tx=holder.x+Math.cos(aang)*rp,ty=holder.y+Math.sin(aang)*rp;
    var tdx=tx-ch.x,tdy=ty-ch.y,td=Math.hypot(tdx,tdy);
    if(td>5){ch.x+=tdx/td*ch.speed;ch.y+=tdy/td*ch.speed;}
    if(cd<18){doIntercept();return;}
    var ct=free[0],mcd=-1;
    free.forEach(function(a){var s=segDist(ch.x,ch.y,holder.x,holder.y,a.x,a.y);if(s>mcd){mcd=s;ct=a;}});
    var W=canvas.width,H=canvas.height,mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
    var mx2=holder.x+(ct.x-holder.x)*.55,my2=holder.y+(ct.y-holder.y)*.55;
    var cvx=Math.max(mx+15,Math.min(mx+fw-15,mx2)),cvy=Math.max(my+15,Math.min(my+fh-15,my2));
    var cdx=cvx-cv.x,cdy=cvy-cv.y,cvd=Math.hypot(cdx,cdy);
    if(cvd>5){cv.x+=cdx/cvd*cv.speed*.8;cv.y+=cdy/cvd*cv.speed*.8;}
    if(Math.hypot(cv.x-holder.x,cv.y-holder.y)<18){doIntercept();return;}
  }
  checkFollow();
}

function doIntercept() {
  if(state.phase==='gameover'||state.phase==='intercepted') return;
  state.phase='intercepted'; state.cuts++; state.time=Math.max(0,state.time-5);
  setCoaching(rand(TIPS.cut),'bad'); updateStats();
  tutCutEvent();
  setTimeout(function(){if(state.phase!=='gameover'){initGame();draw();}},700);
}

function isBlocked(from,to) {
  return defenders.some(function(d){return segDist(d.x,d.y,from.x,from.y,to.x,to.y)<16;});
}

function segDist(px,py,ax,ay,bx,by){
  var abx=bx-ax,aby=by-ay,len2=abx*abx+aby*aby;
  if(!len2) return Math.hypot(px-ax,py-ay);
  var t=Math.max(0,Math.min(1,((px-ax)*abx+(py-ay)*aby)/len2));
  return Math.hypot(px-(ax+t*abx),py-(ay+t*aby));
}

function isThroughPass(from,to){
  if(numDef()<2) return false;
  return segsIntersect(from.x,from.y,to.x,to.y,defenders[0].x,defenders[0].y,defenders[1].x,defenders[1].y);
}
function segsIntersect(ax,ay,bx,by,cx,cy,dx,dy){
  var d1x=bx-ax,d1y=by-ay,d2x=dx-cx,d2y=dy-cy;
  var cr=d1x*d2y-d1y*d2x;
  if(Math.abs(cr)<.0001) return false;
  var t=((cx-ax)*d2y-(cy-ay)*d2x)/cr,u=((cx-ax)*d1y-(cy-ay)*d1x)/cr;
  return t>.05&&t<.95&&u>.05&&u<.95;
}

function celebrateThrough(mx,my){
  var cont=document.getElementById('field-container');
  var cw=canvas.clientWidth,ch=canvas.clientHeight;
  var b=document.createElement('div');
  b.className='through-banner';
  var msgs=['THROUGH PASS! ğŸ”¥','ãƒŠã‚¤ã‚¹ ã‚¹ãƒ«ãƒ¼ï¼ âš¡','Dã®é–“ã‚’æŠœã„ãŸï¼ ğŸ¯'];
  b.textContent=msgs[Math.floor(Math.random()*msgs.length)];
  cont.appendChild(b); setTimeout(function(){if(b.parentNode)b.parentNode.removeChild(b);},1900);
  var stars=['â­','âœ¨','ğŸŒŸ','ğŸ’«','âš¡'];
  for(var i=0;i<7;i++){(function(ii){
    var s=document.createElement('div');
    s.className='star-p'; s.textContent=stars[ii%stars.length];
    s.style.left=(mx/canvas.width*cw)+'px'; s.style.top=(my/canvas.height*ch)+'px';
    var ang=(ii/7)*Math.PI*2,r=45+Math.random()*30;
    s.style.setProperty('--ft','translate('+Math.cos(ang)*r+'px,'+Math.sin(ang)*r+'px)');
    s.style.animationDelay=(ii*.06)+'s';
    cont.appendChild(s); setTimeout(function(){if(s.parentNode)s.parentNode.removeChild(s);},1600);
  })(i);}
}

// â”€â”€ Pass â”€â”€
function executePass(tid) {
  if(state.phase!=='select') return;
  var holder=attackers[state.ball.owner],target=null;
  for(var i=0;i<attackers.length;i++){if(attackers[i].id===tid){target=attackers[i];break;}}
  if(!target) return;

  if(isBlocked(holder,target)){
    showPopup('ã‚«ãƒƒãƒˆï¼',(holder.x+target.x)/2,(holder.y+target.y)/2-10,'#ff4444');
    state.cuts++; setCoaching(rand(TIPS.cut),'bad'); updateStats();
    state.phase='intercepted';
    tutCutEvent();
    setTimeout(function(){if(state.phase!=='gameover'){initGame();draw();}},700);
    return;
  }

  var isWedgePass=isWedgeMode()&&target.isWedge&&isThroughPass(holder,target);
  var through=!isWedgePass&&isThroughPass(holder,target);

  if(isWedgePass){
    var mx=(holder.x+target.x)/2,my=(holder.y+target.y)/2;
    setTimeout(function(){celebrateThrough(mx,my);},120);
    setCoaching(rand(TIPS.wedge),'good');
    tutEvent('through_pass');
  } else if(through){
    var mx2=(holder.x+target.x)/2,my2=(holder.y+target.y)/2;
    setTimeout(function(){celebrateThrough(mx2,my2);},120);
    setCoaching('ğŸ”¥ ãƒŠã‚¤ã‚¹ï¼Dã®é–“ã‚’é€šã—ãŸï¼','good');
    tutEvent('through_pass');
  } else {
    var openLines=attackers.filter(function(a){
      return a.id!==state.ball.owner&&a.openBody&&!isBlocked(holder,a);
    }).length;
    if(target.openBody&&!isBlocked(holder,target)){
      tutEvent('open_pass');
      if(openLines>=2) tutEvent('multi_open_pass');
    } else {
      tutEvent('closed_pass');
    }
    if(target.following||target.returningHome) tutEvent('pass_to_follow');
    showPopup(target.openBody?'OPENï¼':'CLOSEâ€¦',target.x,target.y-28,target.openBody?'#b8ff4e':'#ffaa44');
  }
  tutEvent('any_pass');
  doAnimate(holder.x,holder.y,target.x,target.y,tid,false,isWedgePass);
}

function doAnimate(fx,fy,tx,ty,tid,isLayoff,isWedge){
  state.phase='pass';
  if(animFrame) cancelAnimationFrame(animFrame);
  var dur=isLayoff?200:270, t0=performance.now();
  function step(now){
    var t=Math.min((now-t0)/dur,1),e=t<.5?2*t*t:-1+(4-2*t)*t;
    state.ball.x=fx+(tx-fx)*e; state.ball.y=fy+(ty-fy)*e; state.ball.moving=true; draw();
    if(t<1){animFrame=requestAnimationFrame(step);return;}
    state.ball.owner=tid; state.ball.x=tx; state.ball.y=ty; state.ball.moving=false;
    state.passes++; updateStats();
    if(state.passes%10===0){
      state.level++; setCoaching(rand(TIPS.levelup),'good');
      defenders.forEach(function(d){d.speed+=0.3;});
    } else if(!isWedge&&!isLayoff&&!tutState.active){
      var rec=null;
      for(var i=0;i<attackers.length;i++){if(attackers[i].id===tid){rec=attackers[i];break;}}
      if(rec&&!rec.isWedge) setCoaching(rand(rec.openBody?TIPS.open:TIPS.closed),rec.openBody?'good':'bad');
    }
    updateHomes();
    attackers.forEach(function(a){
      if(a.id===tid) return;
      if(a.following){a.following=false;a.returningHome=true;a.followTarget={x:a.homeX,y:a.homeY};}
    });
    randomBodyAngles(tid);
    state.phase='select';
    if(isWedge) triggerLayoff(tid);
    else{
      var w=null;
      for(var i=0;i<attackers.length;i++){if(attackers[i].isWedge){w=attackers[i];break;}}
      if(w&&w.id!==tid) w.wedgeState='idle';
    }
    draw();
  }
  animFrame=requestAnimationFrame(step);
}

// â”€â”€ Timer â”€â”€
function startTimer(){
  if(state.timerInterval) clearInterval(state.timerInterval);
  state.timerInterval=setInterval(function(){
    if(state.phase==='gameover'){clearInterval(state.timerInterval);return;}
    state.time=Math.max(0,state.time-1);
    document.getElementById('stat-time').textContent=state.time;
    var f=document.getElementById('timer-fill');
    f.style.width=(state.time/60*100)+'%';
    f.style.background=state.time>20?'#b8ff4e':state.time>10?'#ffe600':'#ff3b3b';
    if(!state.time) gameOver();
  },1000);
}
function gameOver(){
  state.phase='gameover'; clearInterval(state.timerInterval);
  setCoaching('â± ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼ãƒ‘ã‚¹:'+state.passes+'æœ¬ ã‚«ãƒƒãƒˆ:'+state.cuts+'å›',state.passes>state.cuts?'good':'bad');
  draw();
}

// â”€â”€ Draw â”€â”€
function draw(){
  if(!canvas.width||!canvas.height) return;
  var W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  drawField(W,H); drawLines(W,H); drawAttackers(); drawDefs(); drawBall();
  if(state.phase==='gameover') drawEnd(W,H);
}

function drawField(W,H){
  var mx=W*.1,my=H*.12,fw=W*.8,fh=H*.76;
  for(var i=0;i<6;i++){ctx.fillStyle=i%2?'#226038':'#1e7a30';ctx.fillRect(mx+fw*i/6,my,fw/6,fh);}
  ctx.strokeStyle='rgba(255,255,255,0.7)';ctx.lineWidth=2.5;ctx.strokeRect(mx,my,fw,fh);
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.setLineDash([4,5]);
  ctx.beginPath();ctx.moveTo(mx,my+fh/2);ctx.lineTo(mx+fw,my+fh/2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(mx+fw/2,my);ctx.lineTo(mx+fw/2,my+fh);ctx.stroke();
  ctx.setLineDash([]);
}

function drawLines(W,H){
  if(state.phase!=='select') return;
  var holder=attackers[state.ball.owner];
  if(isWedgeMode()&&defenders.length===2){
    var d0=defenders[0],d1=defenders[1],gx=(d0.x+d1.x)/2,gy=(d0.y+d1.y)/2;
    ctx.beginPath();ctx.moveTo(d0.x,d0.y);ctx.lineTo(gx,gy-H*.04);ctx.lineTo(d1.x,d1.y);
    ctx.fillStyle='rgba(100,220,255,0.06)';ctx.fill();
    ctx.strokeStyle='rgba(100,220,255,0.18)';ctx.lineWidth=1.5;ctx.setLineDash([3,4]);ctx.stroke();ctx.setLineDash([]);
  }
  attackers.forEach(function(a){
    if(a.id===state.ball.owner) return;
    ctx.beginPath();ctx.moveTo(holder.x,holder.y);ctx.lineTo(a.x,a.y);
    ctx.strokeStyle=isBlocked(holder,a)?'rgba(255,59,59,0.35)':'rgba(184,255,78,0.3)';
    ctx.lineWidth=1.8;ctx.setLineDash([5,6]);ctx.stroke();ctx.setLineDash([]);
  });
}

function drawAttackers(){
  attackers.forEach(function(a){
    var hb=a.id===state.ball.owner,r=hb?17:13;
    if(a.isWedge){
      var rr=r+8;
      var wc=a.wedgeState==='receiving'?'rgba(255,220,0,0.5)':a.wedgeState==='open'?'rgba(100,200,255,0.25)':'rgba(100,200,255,0.1)';
      ctx.beginPath();ctx.moveTo(a.x,a.y-rr);ctx.lineTo(a.x+rr,a.y);ctx.lineTo(a.x,a.y+rr);ctx.lineTo(a.x-rr,a.y);ctx.closePath();
      ctx.fillStyle=wc;ctx.fill();ctx.strokeStyle=hb?'#ffe600':'rgba(100,220,255,0.6)';ctx.lineWidth=2;ctx.stroke();
      if(!hb){ctx.font='bold 8px Arial';ctx.fillStyle='#7de8ff';ctx.textAlign='center';ctx.fillText('ãã•ã³',a.x,a.y+r+20);}
    }
    if(a.following){
      ctx.beginPath();ctx.arc(a.x,a.y,r+10,0,Math.PI*2);
      var pg=ctx.createRadialGradient(a.x,a.y,r,a.x,a.y,r+14);
      pg.addColorStop(0,'rgba(255,149,0,0.32)');pg.addColorStop(1,'transparent');
      ctx.fillStyle=pg;ctx.fill();
    }
    if(!hb){
      var ax2=Math.cos(a.bodyAngle),ay2=Math.sin(a.bodyAngle);
      var col=a.openBody?'rgba(184,255,78,0.9)':'rgba(255,100,100,0.7)';
      ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(a.x+ax2*21,a.y+ay2*21);
      ctx.strokeStyle=col;ctx.lineWidth=2.5;ctx.stroke();
      var hx=a.x+ax2*21,hy=a.y+ay2*21;
      ctx.beginPath();ctx.moveTo(hx-ay2*5,hy+ax2*5);ctx.lineTo(hx+ax2*7,hy+ay2*7);ctx.lineTo(hx+ay2*5,hy-ax2*5);
      ctx.fillStyle=col;ctx.fill();
    }
    if(hb){
      ctx.beginPath();ctx.arc(a.x,a.y,r+9,0,Math.PI*2);
      var gg=ctx.createRadialGradient(a.x,a.y,r,a.x,a.y,r+12);
      gg.addColorStop(0,'rgba(59,170,255,0.38)');gg.addColorStop(1,'transparent');ctx.fillStyle=gg;ctx.fill();
    }
    ctx.beginPath();ctx.arc(a.x,a.y,r,0,Math.PI*2);
    var g=ctx.createRadialGradient(a.x-r*.3,a.y-r*.3,1,a.x,a.y,r);
    if(a.following){g.addColorStop(0,'#ffd080');g.addColorStop(1,'#b85000');}
    else if(a.returningHome){g.addColorStop(0,'#b0b0ff');g.addColorStop(1,'#3030aa');}
    else{g.addColorStop(0,'#7bcfff');g.addColorStop(1,'#1a6fcc');}
    ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle=hb?'#b8ff4e':(a.following?'#ff9500':(a.returningHome?'#aaaaff':'rgba(255,255,255,0.5)'));
    ctx.lineWidth=hb?3:(a.following||a.returningHome?2:1.5);ctx.stroke();
    ctx.font='bold '+Math.round(r*.85)+'px Arial';ctx.fillStyle='white';
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(a.id+1,a.x,a.y);ctx.textBaseline='alphabetic';
    if(!hb&&!a.isWedge){
      var lbl=a.following?'RUN!':(a.returningHome?'HOME':(a.openBody?'OPEN':'CLOSE'));
      var lc=a.following?'#ff9500':(a.returningHome?'#aaaaff':(a.openBody?'#b8ff4e':'#ff8080'));
      ctx.font='bold 8px Arial';ctx.fillStyle=lc;ctx.textAlign='center';ctx.fillText(lbl,a.x,a.y+r+11);
      ctx.beginPath();ctx.arc(a.x,a.y,r+4,0,Math.PI*2);
      ctx.strokeStyle=a.openBody&&!isBlocked(attackers[state.ball.owner],a)?'rgba(184,255,78,0.4)':'rgba(255,255,255,0.08)';
      ctx.lineWidth=1.5;ctx.setLineDash([3,4]);ctx.stroke();ctx.setLineDash([]);
    }
    ctx.textAlign='left';
  });
}

function drawDefs(){
  if(numDef()===2&&defenders.length===2){
    var ch=defenders[0],cv=defenders[1],holder=attackers[state.ball.owner];
    var ang=Math.atan2(holder.y-ch.y,holder.x-ch.x);
    ctx.beginPath();ctx.moveTo(ch.x,ch.y);ctx.arc(ch.x,ch.y,36,ang-.38,ang+.38);ctx.closePath();
    ctx.fillStyle='rgba(255,80,80,0.09)';ctx.fill();
    ctx.beginPath();ctx.moveTo(ch.x,ch.y);ctx.lineTo(cv.x,cv.y);
    ctx.strokeStyle='rgba(255,80,80,0.18)';ctx.lineWidth=2;ctx.setLineDash([5,5]);ctx.stroke();ctx.setLineDash([]);
    ctx.font='bold 8px Arial';ctx.textAlign='center';ctx.fillStyle='rgba(255,150,150,0.8)';
    ctx.fillText('C1',ch.x,ch.y-17);ctx.fillText('C2',cv.x,cv.y-17);ctx.textAlign='left';
  }
  defenders.forEach(function(d){
    ctx.beginPath();ctx.arc(d.x,d.y,20,0,Math.PI*2);
    var g=ctx.createRadialGradient(d.x,d.y,6,d.x,d.y,20);
    g.addColorStop(0,'rgba(255,59,59,0.22)');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fill();
    ctx.beginPath();ctx.arc(d.x,d.y,13,0,Math.PI*2);
    var dg=ctx.createRadialGradient(d.x-3,d.y-3,1,d.x,d.y,13);
    dg.addColorStop(0,'#ff6060');dg.addColorStop(1,'#991010');ctx.fillStyle=dg;ctx.fill();
    ctx.strokeStyle='rgba(255,120,120,0.8)';ctx.lineWidth=2;ctx.stroke();
    ctx.font='bold 10px Arial';ctx.fillStyle='white';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('D',d.x,d.y);ctx.textBaseline='alphabetic';ctx.textAlign='left';
  });
}

function drawBall(){
  var bx=state.ball.moving?state.ball.x:attackers[state.ball.owner].x;
  var by=state.ball.moving?state.ball.y:attackers[state.ball.owner].y;
  ctx.beginPath();ctx.arc(bx,by,6.5,0,Math.PI*2);
  var bg=ctx.createRadialGradient(bx-2,by-2,1,bx,by,6.5);
  bg.addColorStop(0,'white');bg.addColorStop(0.6,'#ddd');bg.addColorStop(1,'#aaa');
  ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.stroke();
  ctx.beginPath();ctx.ellipse(bx+3,by+7,5,2.5,0,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,0.28)';ctx.fill();
}

function drawEnd(W,H){
  ctx.fillStyle='rgba(0,0,0,0.62)';ctx.fillRect(0,0,W,H);
  ctx.font='bold '+Math.round(W*.055)+'px Orbitron,sans-serif';ctx.fillStyle='#b8ff4e';ctx.textAlign='center';
  ctx.fillText('ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼',W/2,H*.42);
  ctx.font=Math.round(W*.034)+'px sans-serif';ctx.fillStyle='white';
  ctx.fillText('ãƒ‘ã‚¹:'+state.passes+'æœ¬  ã‚«ãƒƒãƒˆ:'+state.cuts+'å›',W/2,H*.57);
  ctx.font=Math.round(W*.026)+'px sans-serif';ctx.fillStyle='rgba(255,255,255,0.4)';
  ctx.fillText('ã€Œå†ã‚¹ã‚¿ãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã§å†æŒ‘æˆ¦ï¼',W/2,H*.7);ctx.textAlign='left';
}

function showPopup(text,x,y,color){
  var div=document.createElement('div');
  div.className='popup';div.textContent=text;div.style.color=color||'#b8ff4e';
  var c=document.getElementById('field-container');
  div.style.left=(x/canvas.width*canvas.clientWidth)+'px';
  div.style.top=(y/canvas.height*canvas.clientHeight)+'px';
  c.appendChild(div);setTimeout(function(){if(div.parentNode)div.parentNode.removeChild(div);},1200);
}

// â”€â”€ Input â”€â”€
function handleTap(cx,cy){
  if(state.phase!=='select') return;
  var rect=canvas.getBoundingClientRect();
  var sx=canvas.width/canvas.clientWidth,sy=canvas.height/canvas.clientHeight;
  var gx=(cx-rect.left)*sx,gy=(cy-rect.top)*sy;
  for(var i=0;i<attackers.length;i++){
    var a=attackers[i];
    if(a.id===state.ball.owner) continue;
    if(Math.hypot(gx-a.x,gy-a.y)<22){executePass(a.id);return;}
  }
  setCoaching('ãƒ‘ã‚¹ã—ãŸã„ä»²é–“ã®ç•ªå·ã‚’ã‚¿ãƒƒãƒ—ï¼','');
}
canvas.addEventListener('click',function(e){handleTap(e.clientX,e.clientY);});
canvas.addEventListener('touchstart',function(e){e.preventDefault();handleTap(e.touches[0].clientX,e.touches[0].clientY);},{passive:false});

// â”€â”€ Game Loop â”€â”€
function startDefLoop(){
  if(defLoop) clearInterval(defLoop);
  defLoop=setInterval(function(){
    if(state.phase==='select'){updateDefs();moveFollowers();updateWedge();draw();}
  },40);
}

function restartGame(){
  clearInterval(state.timerInterval);
  if(animFrame) cancelAnimationFrame(animFrame);
  if(state.wedgeTimer) clearTimeout(state.wedgeTimer);
  state.passes=0;state.cuts=0;state.level=1;state.time=60;state.lastFollowTime=0;
  document.getElementById('stat-time').textContent=60;
  document.getElementById('timer-fill').style.width='100%';
  updateStats();
  resize();
  initGame();
  startDefLoop();
  startTimer();
  draw();
}

function setMode(m){
  gameMode=m;
  ['4v1','4v2','5v2'].forEach(function(k){
    document.getElementById('mode-'+k).classList.toggle('active',k===m);
  });
  if(tutState.active) closeTutPanel();
  restartGame();
}

document.getElementById('btn-start').addEventListener('click',function(){
  if(tutState.active) closeTutPanel();
  restartGame();
});

document.getElementById('btn-hint').addEventListener('click',function(){
  if(state.phase!=='select') return;
  var holder=attackers[state.ball.owner];
  var safe=attackers.filter(function(a){return a.id!==state.ball.owner&&a.openBody&&!isBlocked(holder,a);});
  var open=attackers.filter(function(a){return a.id!==state.ball.owner&&a.openBody;});
  if(safe.length) setCoaching('ğŸ’¡ '+(safe[0].id+1)+'ç•ªãŒOPENï¼†ã‚³ãƒ¼ã‚¹ã‚ã‚Šï¼ã‚¿ãƒƒãƒ—ã—ã¦ãƒ‘ã‚¹ï¼','good');
  else if(open.length) setCoaching('ğŸ’¡ '+(open[0].id+1)+'ç•ªã¯OPENã ã‘ã©DãŒé‚ªé­”ï¼','');
  else setCoaching('ğŸ’¡ å…¨å“¡CLOSEã ã‘ã©ãƒ‘ã‚¹ã™ã‚‹ã—ã‹ãªã„ï¼ä½“ã®å‘ãã‚’è¦šãˆã‚ˆã†','bad');
});

// â”€â”€ Boot â”€â”€
renderLessons();
resize();
restartGame();
</script>
</body>
</html>
